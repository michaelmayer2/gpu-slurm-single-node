<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Mayer">

<title>GPU and SLURM with Posit Workbench – Single node SLURM setup for GPU computing with Posit Workbench</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5027bf1c1f92ac6615724d89c8213d6a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Single node SLURM setup for GPU computing with Posit Workbench</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./GPU-SLURM.html" aria-current="page"> 
<span class="menu-text">Technical doc</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/michaelmayer2/gpu-slurm-single-node" target="_blank">
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/michaelmayer2/gpu-slurm-single-node/issues/new?assignees=&amp;labels=bug&amp;projects=&amp;template=bug_report.md&amp;title=" target="_blank">
 <span class="dropdown-text">Report a Bug</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#general-information-for-our-setup" id="toc-general-information-for-our-setup" class="nav-link" data-scroll-target="#general-information-for-our-setup">General Information for our setup</a>
  <ul class="collapse">
  <li><a href="#aws-setup" id="toc-aws-setup" class="nav-link" data-scroll-target="#aws-setup">AWS setup</a></li>
  <li><a href="#user-data-script" id="toc-user-data-script" class="nav-link" data-scroll-target="#user-data-script">user-data script</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">GPU and SLURM with Posit Workbench</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Michael Mayer </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>With the ever increasing popularity of AI, more and more customers are exploring the use of GPU’s with Posit Workbench. Many larger customers today have a Kubernetes or SLURM based Workbench environment for scalability. Those environments can be easily configured to allocate GPU’s to Workbench sessions and general compute jobs as consumable resource.</p>
<p>Smaller to medium sized customers however sturggle a bit with the use of GPUs. In many cases they only can afford a single GPU on a server, many of them are still working on-prem but still want to make GPU computing available to their data scientists.</p>
<p>The below describes a possibility on how to configure a server with a single GPU so that it can be leveraged as a GPU server for a group of data scientists that can get shared access to the same GPU resources.</p>
<p>While the general description and all testing for this document was done on AWS, the same approach can easily be converted into an on-prem installation procedure.</p>
</section>
<section id="general-information-for-our-setup" class="level2">
<h2 class="anchored" data-anchor-id="general-information-for-our-setup">General Information for our setup</h2>
<p>For the detailed description below we will be using an AWS GPU instance and a standard AMI for Rocky Linux 9.3.</p>
<p>We will be using the AWS CLI tools to create a <code>p3.2xlarge</code> instance with some user-data script. In this userdata script, <a href="https://docs.posit.co/resources/install-r/">R</a>, <a href="https://docs.posit.co/resources/install-python/">Python</a> and <a href="https://docs.posit.co/ide/server-pro/getting_started/installation/installation.html#download-and-install">Workbench</a> will be installed using Posit provided binaries. SLURM will be compiled from source in the version specified.</p>
<section id="aws-setup" class="level3">
<h3 class="anchored" data-anchor-id="aws-setup">AWS setup</h3>
<p>First of all we need to define various parameters of our AWS account</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Parameter name</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>VPC_ID</code></td>
<td>ID of VPC to be used</td>
<td><code>vpc-1486376d</code></td>
</tr>
<tr class="even">
<td><code>SUBNET_ID</code></td>
<td>ID of a public subnet</td>
<td><code>subnet-cd7e8c86</code></td>
</tr>
<tr class="odd">
<td><code>AMI_ID</code></td>
<td>ID of an AWS AMI that contains Rocky Linux 9</td>
<td><code>ami-05a40a9d755b0f73a</code></td>
</tr>
<tr class="even">
<td><code>KEY_PAIR</code></td>
<td>Name of SSH key pair to be used for logging into the EC2 instance</td>
<td><code>michael.mayer@posit.co-keypair-for-pulumi</code></td>
</tr>
<tr class="odd">
<td><code>POSIT_TAGS</code></td>
<td>Tags to be used for AWS resource cretion</td>
<td><code>"{Key=rs:project,Value=solutions}, \             {Key=rs:environment,Value=development}, \             {Key=rs:owner,Value=michael.mayer@posit.co}"</code></td>
</tr>
</tbody>
</table>
<p>Once those parameters are defined we can create a security group to allow ingress on port 22 (ssh) and 8787 (workbench)</p>
<div id="dbaf23e3" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>SG_ID<span class="op">=</span>`aws ec2 create<span class="op">-</span>security<span class="op">-</span>group <span class="op">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>group<span class="op">-</span>name ssh<span class="op">-</span>wb<span class="op">-</span>sg <span class="op">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>description <span class="st">"SG for Workbench (port 8787) and SSH (port 22) access"</span> \</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>tag<span class="op">-</span>specifications <span class="st">"ResourceType=security-group,</span><span class="ch">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">        Tags=[{Key=Name,Value=ssh-wb-sg},$</span><span class="sc">{POSIT_TAGS}</span><span class="st">]"</span> \</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>vpc<span class="op">-</span><span class="bu">id</span> <span class="st">"$</span><span class="sc">{VPC_ID}</span><span class="st">"</span> <span class="op">|</span> jq <span class="op">-</span>r <span class="st">'.GroupId'</span> `</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>aws ec2 authorize<span class="op">-</span>security<span class="op">-</span>group<span class="op">-</span>ingress <span class="op">\</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>group<span class="op">-</span><span class="bu">id</span> <span class="st">"$</span><span class="sc">{SG_ID}</span><span class="st">"</span> \</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>protocol tcp <span class="op">\</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>port <span class="dv">8787</span> <span class="op">\</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>cidr <span class="st">"0.0.0.0/0"</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>aws ec2 authorize<span class="op">-</span>security<span class="op">-</span>group<span class="op">-</span>ingress <span class="op">\</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>group<span class="op">-</span><span class="bu">id</span> <span class="st">"$</span><span class="sc">{SG_ID}</span><span class="st">"</span> \</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>protocol tcp <span class="op">\</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>port <span class="dv">22</span> <span class="op">\</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>cidr <span class="st">"0.0.0.0/0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and finally we can create the EC2 instance via</p>
<div id="d01595e9" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>aws ec2 run<span class="op">-</span>instances <span class="op">\</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>image<span class="op">-</span><span class="bu">id</span> $AMI_ID <span class="op">\</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>count <span class="dv">1</span> <span class="op">\</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>instance<span class="op">-</span><span class="bu">type</span> p3<span class="fl">.2</span><span class="er">xlarge</span> <span class="op">\</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>key<span class="op">-</span>name $KEY_PAIR <span class="op">\</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>security<span class="op">-</span>group<span class="op">-</span>ids $SG_ID <span class="op">\</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>block<span class="op">-</span>device<span class="op">-</span>mappings <span class="st">"[{</span><span class="ch">\"</span><span class="st">DeviceName</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">/dev/sda1</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">Ebs</span><span class="ch">\"</span><span class="st">:{</span><span class="ch">\"</span><span class="st">VolumeSize</span><span class="ch">\"</span><span class="st">:100,</span><span class="ch">\"</span><span class="st">DeleteOnTermination</span><span class="ch">\"</span><span class="st">:true</span><span class="sc">}}</span><span class="st">]"</span> \</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>tag<span class="op">-</span>specifications <span class="st">"ResourceType=instance,Tags=[{Key=Name,Value=rl9-gpu},$</span><span class="sc">{POSIT_TAGS}</span><span class="st">]"</span> <span class="st">'ResourceType=volume,Tags=[{Key=Name,Value=rl9-gpu-disk}]'</span> \</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>user<span class="op">-</span>data <span class="bu">file</span>:<span class="op">//</span>${PWD}<span class="op">/</span>user<span class="op">-</span>data.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In your EC2 console you then will be able to see a new server with Name <code>rl9-gpu</code> appearing - once it is up and running, you can connect to it to check progress. Please note the server will reboot once before fully ready. This is needed to rebuild the nvidia kernel modules for the linux kernel.</p>
</section>
<section id="user-data-script" class="level3">
<h3 class="anchored" data-anchor-id="user-data-script">user-data script</h3>
<section id="introduction-and-overview" class="level4">
<h4 class="anchored" data-anchor-id="introduction-and-overview">Introduction and Overview</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Parameter name</th>
<th>Description</th>
<th>Default value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>R_VERSION_LIST</code></td>
<td>List of R versions to be installed</td>
<td><code>"3.6.3 4.0.5 4.1.3 4.2.3 4.3.3"</code></td>
</tr>
<tr class="even">
<td><code>PYTHON_VERSION_LIST</code></td>
<td>List of Python versions to be installed</td>
<td><code>"3.8.19 3.9.19 3.10.14 3.11.8"</code></td>
</tr>
<tr class="odd">
<td><code>SLURM_VERSION</code></td>
<td>Version of SLURM to be used</td>
<td><code>23.11.5-1</code></td>
</tr>
<tr class="even">
<td><code>PWB_VERSION</code></td>
<td>Version of Posit Workbench to be used</td>
<td><code>2024.04.0-daily-675.pro4</code></td>
</tr>
</tbody>
</table>
<p>All of the above parameters can be modified at the start to the user-data script.</p>
</section>
<section id="selinux" class="level4">
<h4 class="anchored" data-anchor-id="selinux">SELinux</h4>
<p>First, we will turn SELinux into permissive mode - this is needed for Workbench to run properly (mainly issues in Launcher)</p>
<div id="34a6fdea" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>setenforce permissive</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/^SELINUX=.*/SELINUX=permissive/'</span> <span class="op">/</span>etc<span class="op">/</span>sysconfig<span class="op">/</span>selinux </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/^SELINUX=.*/SELINUX=permissive/'</span> <span class="op">/</span>etc<span class="op">/</span>selinux<span class="op">/</span>config</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>grubby <span class="op">--</span>update<span class="op">-</span>kernel ALL <span class="op">--</span>args selinux<span class="op">=</span>permissive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="configuring-the-gpu" class="level4">
<h4 class="anchored" data-anchor-id="configuring-the-gpu">Configuring the GPU</h4>
<p>This is described in great detail at <a href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#network-repo-installation-for-rhel-9-rocky-9">NVIDIA docs</a>. It will install the NVIDIA driver (550 series) and CUDA 12.4.</p>
<div id="4ae889fb" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y <span class="st">'dnf-command(config-manager)'</span> epel<span class="op">-</span>release</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>crb enable</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dnf config<span class="op">-</span>manager <span class="op">--</span>add<span class="op">-</span>repo <span class="op">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  https:<span class="op">//</span>developer.download.nvidia.com<span class="op">/</span>compute<span class="op">/</span>cuda<span class="op">/</span>repos<span class="op">/</span>rhel9<span class="op">/</span>x86_64<span class="op">/</span>cuda<span class="op">-</span>rhel9.repo</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>dnf clean expire<span class="op">-</span>cache</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y dkms</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>dnf module install <span class="op">-</span>y nvidia<span class="op">-</span>driver:<span class="dv">550</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y cuda<span class="op">-</span>toolkit<span class="op">-</span><span class="dv">12</span><span class="op">-</span><span class="dv">4</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y libcudnn8</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>etc<span class="op">/</span>profile.d<span class="op">/</span>cuda.sh</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>export PATH<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span>cuda<span class="op">/</span><span class="bu">bin</span>:\$PATH</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>export LD_LIBRARY_PATH<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span>cuda<span class="op">/</span>lib64:\$LD_LIBRARY_PATH</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>EOF</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The above command will download about 5 GB of data. It will additionally install <code>libcudnn8</code> and set both <code>PATH</code> and <code>LD_LIBRARY_PATH</code> so that the CUDA tools are usable. The <code>libcudnn8</code> and <code>LD_LIBRARY_PATH</code> are important to make <a href="https://github.com/tensorflow/tensorflow/issues/63362">TensorFlow 2.16.1 work</a>.</p>
</section>
<section id="setting-up-r" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-r">Setting up R</h4>
<p>We will install a list of <a href="https://docs.posit.co/resources/install-r/">R versions</a> and configure each for Java support.</p>
<div id="e326777d" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>export R_VERSION_LIST<span class="op">=</span><span class="st">"3.6.3 4.0.5 4.1.3 4.2.3 4.3.3"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># While CUDA seems to prefer JAVA 11, Binary R packages are typically compiled with Java 8 only. </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>dnf <span class="op">-</span>y install java<span class="op">-</span><span class="fl">1.8.0</span><span class="op">-</span>openjdk<span class="op">-</span>devel</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>curl <span class="op">-</span>O  https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>sol<span class="op">-</span>eng<span class="op">/</span>singularity<span class="op">-</span>rstudio<span class="op">/</span>main<span class="op">/</span>data<span class="op">/</span>r<span class="op">-</span>session<span class="op">-</span>complete<span class="op">/</span>centos7<span class="op">/</span>scripts<span class="op">/</span>run.R</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>curl <span class="op">-</span>O  https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>sol<span class="op">-</span>eng<span class="op">/</span>singularity<span class="op">-</span>rstudio<span class="op">/</span>main<span class="op">/</span>data<span class="op">/</span>r<span class="op">-</span>session<span class="op">-</span>complete<span class="op">/</span>centos7<span class="op">/</span>scripts<span class="op">/</span>bioc.txt</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> R_VERSION <span class="kw">in</span> $R_VERSION_LIST<span class="op">;</span> do yum install <span class="op">-</span>y https:<span class="op">//</span>cdn.rstudio.com<span class="op">/</span>r<span class="op">/</span>rhel<span class="op">-</span><span class="dv">9</span><span class="op">/</span>pkgs<span class="op">/</span>R<span class="op">-</span>${R_VERSION}<span class="op">-</span><span class="dv">1</span><span class="op">-</span><span class="fl">1.</span><span class="er">x86_64</span>.rpm<span class="op">;</span> done</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> R_VERSION <span class="kw">in</span> $R_VERSION_LIST<span class="op">;</span> do <span class="op">\</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        export PATH<span class="op">=/</span>opt<span class="op">/</span>R<span class="op">/</span>$R_VERSION<span class="op">/</span><span class="bu">bin</span>:$PATH <span class="op">&amp;&amp;</span> <span class="op">\</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        export JAVA_HOME<span class="op">=/</span>usr<span class="op">/</span>lib<span class="op">/</span>jvm<span class="op">/</span>java<span class="op">-</span><span class="fl">1.8.0</span><span class="op">-</span>openjdk<span class="op">/</span> <span class="op">&amp;&amp;</span> <span class="op">\</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>opt<span class="op">/</span>R<span class="op">/</span>${R_VERSION}<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>R CMD javareconf </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="setting-up-python" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-python">Setting up Python</h4>
<p>We will install a list of <a href="https://docs.posit.co/resources/install-python/">Python versions</a> and configure JupyterLab for the last python version mentioned in <code>PYTHON_VERSION_LIST</code>.</p>
<div id="4e9c27ce" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python installation </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $PYTHON_VERSION_LIST ]<span class="op">;</span> then PYTHON_VERSION_LIST<span class="op">=</span><span class="st">"3.8.19 3.9.19 3.10.14 3.11.8"</span><span class="op">;</span> fi</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> PYTHON_VERSION <span class="kw">in</span> $PYTHON_VERSION_LIST</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>do</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    yum install <span class="op">-</span>y https:<span class="op">//</span>cdn.rstudio.com<span class="op">/</span>python<span class="op">/</span>rhel<span class="op">-</span><span class="dv">9</span><span class="op">/</span>pkgs<span class="op">/</span>python<span class="op">-</span>${PYTHON_VERSION}<span class="op">-</span><span class="dv">1</span><span class="op">-</span><span class="fl">1.</span><span class="er">x86_64</span>.rpm</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>done</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Python version to be used for jupyter install (last one of PYTHON_VERSION_LIST)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>TMPVAR<span class="op">=</span>($PYTHON_VERSION_LIST)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>PYTHON_VERSION<span class="op">=</span>${TMPVAR[<span class="op">@</span>]: <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># JupyterLab Version selected </span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>JUPYTERLAB_VERSION<span class="op">=</span><span class="fl">3.6.5</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span><span class="st">"$</span><span class="sc">{PYTHON_VERSION}</span><span class="st">"</span><span class="op">/</span><span class="bu">bin</span><span class="op">/</span>python <span class="op">-</span>m venv <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter <span class="op">\</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>pip install <span class="op">\</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      jupyter <span class="op">\</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      jupyterlab<span class="op">==</span><span class="st">"$</span><span class="sc">{JUPYTERLAB_VERSION}</span><span class="st">"</span> \</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      rsconnect_jupyter <span class="op">\</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      rsconnect_python <span class="op">\</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      rsp_jupyter <span class="op">\</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      workbench_jupyterlab <span class="op">\</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> ln <span class="op">-</span>s <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter <span class="op">\</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension install <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsp_jupyter <span class="op">\</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension enable <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsp_jupyter <span class="op">\</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension install <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsconnect_jupyter <span class="op">\</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension enable <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsconnect_jupyter <span class="op">\</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>serverextension enable <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsconnect_jupyter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="building-slurm-from-sources" class="level4">
<h4 class="anchored" data-anchor-id="building-slurm-from-sources">Building SLURM from sources</h4>
<p>We will build SLURM from source to ensure we can use the latest version and do not depend on any OS vendor to package SLURM. The minimum version of SLURM we can use is SLURM 22.x due to our use of <a href="https://slurm.schedmd.com/gres.html#Sharding">Sharding</a>.</p>
<p>The SLURM config uses</p>
<ul>
<li><p>Prefix <code>/usr/local</code></p></li>
<li><p>CLI binaries in <code>/usr/local/bin</code> (Note the script to expand <code>PATH</code> below)</p></li>
<li><p><code>slurm.conf</code> in <code>/usr/local/etc/slurm</code></p></li>
</ul>
<!-- -->
<ul>
<li><p>external accounting DB (MariaDB)</p></li>
<li><p>MUNGE authentication</p></li>
<li><p><code>cgroups</code> for cpus, memory and devices (e.g.&nbsp;GPUs)</p></li>
<li><p>all log files are collected in <code>/var/log/slurm/</code></p></li>
<li><p><code>gres.conf</code> for our GPU and 8 shards.</p></li>
</ul>
<div id="3d050aff" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $SLURM_VERSION ]<span class="op">;</span> then export SLURM_VERSION<span class="op">=</span><span class="fl">23.11.5</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y git</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">-</span>r <span class="op">--</span>gid<span class="op">=</span><span class="dv">105</span> munge</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>useradd <span class="op">-</span>r <span class="op">-</span>s <span class="op">/</span><span class="bu">bin</span><span class="op">/</span>bash <span class="op">-</span>g munge <span class="op">--</span>uid<span class="op">=</span><span class="dv">105</span> munge</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y bash<span class="op">-</span>completion mariadb<span class="op">-</span>devel mariadb<span class="op">-</span>server hdf5<span class="op">-</span>devel munge munge<span class="op">-</span>devel dbus<span class="op">-</span>devel hwloc<span class="op">-</span>devel readline<span class="op">-</span>devel lua<span class="op">-</span>devel man2html</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>f <span class="op">/</span>usr<span class="op">/</span>sbin<span class="op">/</span>create<span class="op">-</span>munge<span class="op">-</span>key ]<span class="op">;</span> then <span class="op">/</span>usr<span class="op">/</span>sbin<span class="op">/</span>create<span class="op">-</span>munge<span class="op">-</span>key <span class="op">;</span> <span class="cf">else</span> <span class="op">/</span>usr<span class="op">/</span>sbin<span class="op">/</span>mungekey <span class="op">-</span>c <span class="op">-</span>f<span class="op">;</span> fi</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>export SLURM_PREFIX<span class="op">=/</span>usr<span class="op">/</span>local</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p $SLURM_PREFIX<span class="op">/</span>etc<span class="op">/</span>slurm <span class="op">&amp;&amp;</span> mkdir <span class="op">-</span>p <span class="op">/</span>tmp<span class="op">/</span>build <span class="op">&amp;&amp;</span> cd <span class="op">/</span>tmp<span class="op">/</span>build <span class="op">\</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"git clone --depth 1 -b slurm-\${SLURM_VERSION//./-} https://github.com/SchedMD/slurm.git"</span> \</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> cd slurm <span class="op">\</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> echo <span class="st">"Configuring SLURM $</span><span class="sc">{SLURM_VERSION}</span><span class="st">"</span> \</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"./configure --enable-debug --prefix=$SLURM_PREFIX --sysconfdir=$SLURM_PREFIX/etc/slurm </span><span class="ch">\</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="st">        --with-mysql_config=/usr/bin  --libdir=$SLURM_PREFIX/lib64 --with-systemdsystemunitdir=/usr/lib/systemd/system/ &gt;&amp; $SLURM_PREFIX/etc/slurm/.configure.log"</span>  \</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> echo <span class="st">"Building SLURM $</span><span class="sc">{SLURM_VERSION}</span><span class="st">"</span> \</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"make -j 8 &gt;&amp; $SLURM_PREFIX/etc/slurm/.build.log"</span> \</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> echo <span class="st">"Installing SLURM $</span><span class="sc">{SLURM_VERSION}</span><span class="st">"</span> \</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"make -j 8 install &gt;&amp; $SLURM_PREFIX/etc/slurm/.install.log"</span> \</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> install <span class="op">-</span>D <span class="op">-</span>m644 contribs<span class="op">/</span>slurm_completion_help<span class="op">/</span>slurm_completion.sh <span class="op">/</span>etc<span class="op">/</span>profile.d<span class="op">/</span>slurm_completion.sh <span class="op">\</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> cd .. <span class="op">\</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> rm <span class="op">-</span>rf slurm <span class="op">\</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> groupadd <span class="op">-</span>r <span class="op">--</span>gid<span class="op">=</span><span class="dv">980</span> slurm <span class="op">\</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> useradd <span class="op">-</span>r <span class="op">-</span>g slurm <span class="op">--</span>uid<span class="op">=</span><span class="dv">985</span> slurm <span class="op">\</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> mkdir <span class="op">-</span>p <span class="op">/</span>etc<span class="op">/</span>sysconfig<span class="op">/</span>slurm <span class="op">\</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmd <span class="op">\</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>run<span class="op">/</span>slurm <span class="op">\</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>run<span class="op">/</span>slurmdbd <span class="op">\</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>lib<span class="op">/</span>slurmd <span class="op">\</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>log<span class="op">/</span>slurm <span class="op">\</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmctld <span class="op">\</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> chown <span class="op">-</span>R slurm:slurm <span class="op">/</span>var<span class="op">/*/</span>slurm<span class="op">*</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure /usr/local/bin is in $PATH</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"export PATH=/usr/local/bin:\$PATH"</span> <span class="op">&gt;</span> <span class="op">/</span>etc<span class="op">/</span>profile.d<span class="op">/</span>path<span class="op">-</span>usr<span class="op">-</span>local.sh</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure mariadb</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>systemctl enable mariadb</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>systemctl start mariadb</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>mysql_secure_installation <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>Testme1234</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>Testme1234</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co"># SLURM configuration</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurm.conf</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>ClusterName<span class="op">=</span>pwb</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>SlurmctldHost<span class="op">=</span>localhost</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>ProctrackType<span class="op">=</span>proctrack<span class="op">/</span>cgroup</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>ReturnToService<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>SlurmctldPidFile<span class="op">=/</span>var<span class="op">/</span>run<span class="op">/</span>slurm<span class="op">/</span>slurmctld.pid</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>SlurmctldPort<span class="op">=</span><span class="dv">6817</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>SlurmdPidFile<span class="op">=/</span>var<span class="op">/</span>run<span class="op">/</span>slurm<span class="op">/</span>slurmd.pid</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>SlurmdPort<span class="op">=</span><span class="dv">6818</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>SlurmdSpoolDir<span class="op">=/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmd</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>SlurmUser<span class="op">=</span>slurm</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>StateSaveLocation<span class="op">=/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmctld</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>TaskPlugin<span class="op">=</span>task<span class="op">/</span>affinity,task<span class="op">/</span>cgroup</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>InactiveLimit<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>KillWait<span class="op">=</span><span class="dv">30</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>MinJobAge<span class="op">=</span><span class="dv">300</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>SlurmctldTimeout<span class="op">=</span><span class="dv">120</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>SlurmdTimeout<span class="op">=</span><span class="dv">300</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>Waittime<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>SchedulerType<span class="op">=</span>sched<span class="op">/</span>backfill</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>SelectType<span class="op">=</span>select<span class="op">/</span>cons_tres</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>AccountingStorageType<span class="op">=</span>accounting_storage<span class="op">/</span>slurmdbd</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>AccountingStorageTRES<span class="op">=</span>gres<span class="op">/</span>gpu,gres<span class="op">/</span>shard</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>GresTypes<span class="op">=</span>gpu,shard</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>JobCompType<span class="op">=</span>jobcomp<span class="op">/</span>none</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>JobAcctGatherFrequency<span class="op">=</span><span class="dv">10</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>SlurmctldDebug<span class="op">=</span>info</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>SlurmctldLogFile<span class="op">=/</span>var<span class="op">/</span>log<span class="op">/</span>slurm<span class="op">/</span>slurmctld.log</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>SlurmdDebug<span class="op">=</span>info</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>SlurmdLogFile<span class="op">=/</span>var<span class="op">/</span>log<span class="op">/</span>slurm<span class="op">/</span>slurmd.log</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost CPUs=8 SocketsPerBoard=1 CoresPerSocket=4 ThreadsPerCore=1 Gres=gpu:1,shard:8 State=UNKNOWN</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>NodeName<span class="op">=</span>localhost CPUs<span class="op">=</span><span class="dv">8</span> Boards<span class="op">=</span><span class="dv">1</span> Gres<span class="op">=</span>gpu:v100:<span class="dv">1</span>,shard:<span class="dv">8</span> SocketsPerBoard<span class="op">=</span><span class="dv">1</span> CoresPerSocket<span class="op">=</span><span class="dv">4</span> ThreadsPerCore<span class="op">=</span><span class="dv">2</span> RealMemory<span class="op">=</span><span class="dv">61022</span> State<span class="op">=</span>UNKNOWN</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>PartitionName<span class="op">=</span><span class="bu">all</span> Nodes<span class="op">=</span>ALL Default<span class="op">=</span>YES MaxTime<span class="op">=</span>INFINITE State<span class="op">=</span>UP</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.conf</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>AuthType<span class="op">=</span>auth<span class="op">/</span>munge</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>LogFile<span class="op">=/</span>var<span class="op">/</span>log<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.log</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>PidFile<span class="op">=/</span>var<span class="op">/</span>run<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.pid</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>DbdPort<span class="op">=</span><span class="dv">6819</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>SlurmUser<span class="op">=</span>slurm</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>StorageType<span class="op">=</span>accounting_storage<span class="op">/</span>mysql</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>DbdHost<span class="op">=</span>localhost</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>StorageHost<span class="op">=</span>localhost</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>StoragePort<span class="op">=</span><span class="dv">3306</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>StorageLoc<span class="op">=</span>slurm</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>StorageUser<span class="op">=</span>root</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>StoragePass<span class="op">=</span>Testme1234</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>gres.conf</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>AutoDetect<span class="op">=</span>off</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>NodeName<span class="op">=</span>localhost Name<span class="op">=</span>gpu Type<span class="op">=</span>v100 File<span class="op">=/</span>dev<span class="op">/</span>nvidia0</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>NodeName<span class="op">=</span>localhost Name<span class="op">=</span>shard Count<span class="op">=</span><span class="dv">8</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a><span class="co">#p3.8xlarge</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia0</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia1</span></span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia3</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia2</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=shard Count=8</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>cgroup.conf</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>ConstrainCores<span class="op">=</span>yes</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>ConstrainDevices<span class="op">=</span>yes</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>ConstrainRAMSpace<span class="op">=</span>yes</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>chown slurm <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.conf</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>chmod <span class="dv">0</span><span class="er">600</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.conf</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>systemctl enable munge</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>systemctl enable slurmctld </span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>systemctl enable slurmdbd</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>systemctl enable slurmd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="install-and-configure-workbench" class="level4">
<h4 class="anchored" data-anchor-id="install-and-configure-workbench">Install and configure Workbench</h4>
<p>Workbench will be configured for SLURM Launcher with GRES support only. This will allow the user to specify <code>shard:X</code> as GRES where X can run from 1 to 8. CPU and memory resources have been set up so that they are making most efficient use of the available CPUs and memory.</p>
<p>We also will configure support for all 4 IDE’s, e.g.&nbsp;RStudio IDE, VS Code, Jupyter Notebooks and JupyterLab. A user named <code>rstudio</code> is created that has all admin privileges on Workbench. A random 10-digit password will be assigned and saved in a <code>.rstudio-pw</code> file in the <code>rstudio</code> users’ home-directory.</p>
<div id="51c2db06" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Workbench installation </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $PWB_VERSION ]<span class="op">;</span> then export PWB_VERSION<span class="op">=</span><span class="fl">2024.04.0</span><span class="op">-</span>daily<span class="op">-</span><span class="fl">675.</span><span class="er">pro4</span><span class="op">;</span> fi</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>yum <span class="op">-</span>y install https:<span class="op">//</span>s3.amazonaws.com<span class="op">/</span>rstudio<span class="op">-</span>ide<span class="op">-</span>build<span class="op">/</span>server<span class="op">/</span>rhel9<span class="op">/</span>x86_64<span class="op">/</span>rstudio<span class="op">-</span>workbench<span class="op">-</span>rhel<span class="op">-</span>${PWB_VERSION}<span class="op">-</span>x86_64.rpm</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Workbench setup</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>configdir<span class="op">=</span><span class="st">"/etc/rstudio"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add SLURM integration </span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>myip<span class="op">=</span>`curl http:<span class="op">//</span>checkip.amazonaws.com`</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p <span class="op">/</span>opt<span class="op">/</span>rstudio<span class="op">/</span>shared<span class="op">-</span>storage</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher<span class="op">-</span>env <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>RSTUDIO_DISABLE_PACKAGE_INSTALL_PROMPT<span class="op">=</span>yes</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>SLURM_CONF<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm.conf</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>rserver.conf <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Launcher Config</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>address<span class="op">=</span><span class="fl">127.0.0.1</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>port<span class="op">=</span><span class="dv">5559</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>sessions<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>default<span class="op">-</span>cluster<span class="op">=</span>Slurm</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>sessions<span class="op">-</span>callback<span class="op">-</span>address<span class="op">=</span>http:<span class="op">//</span>${myip}:<span class="dv">8787</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Disable R Versions scanning</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">#r-versions-scan=0</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>auth<span class="op">-</span>pam<span class="op">-</span>sessions<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>auth<span class="op">-</span>pam<span class="op">-</span>sessions<span class="op">-</span>use<span class="op">-</span>password<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable Admin Dashboard</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>group<span class="op">=</span>rstudio<span class="op">-</span>admins</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>superuser<span class="op">-</span>group<span class="op">=</span>rstudio<span class="op">-</span>superuser<span class="op">-</span>admins</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>monitor<span class="op">-</span>log<span class="op">-</span>use<span class="op">-</span>server<span class="op">-</span>time<span class="op">-</span>zone<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>console<span class="op">-</span>user<span class="op">-</span>limit<span class="op">-</span>mb<span class="op">=</span><span class="dv">200</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>console<span class="op">-</span>user<span class="op">-</span>limit<span class="op">-</span>months<span class="op">=</span><span class="dv">3</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable Auditing</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>console<span class="op">=</span><span class="bu">all</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>sessions<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>sessions<span class="op">-</span>limit<span class="op">-</span>mb<span class="op">=</span><span class="dv">512</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>sessions<span class="op">-</span>limit<span class="op">-</span>months<span class="op">=</span><span class="dv">6</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher.conf<span class="op">&lt;&lt;</span>EOF</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>[server]</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>address<span class="op">=</span><span class="fl">127.0.0.1</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>port<span class="op">=</span><span class="dv">5559</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>server<span class="op">-</span>user<span class="op">=</span>rstudio<span class="op">-</span>server</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>group<span class="op">=</span>rstudio<span class="op">-</span>server</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>authorization<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>thread<span class="op">-</span>pool<span class="op">-</span>size<span class="op">=</span><span class="dv">4</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>enable<span class="op">-</span>debug<span class="op">-</span>logging<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>[cluster]</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>name<span class="op">=</span>Slurm</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span><span class="op">=</span>Slurm</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a><span class="co">#[cluster]</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="co">#name=Local</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="co">#type=Local</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="co">#cat &gt; $configdir/launcher.slurm.profiles.conf&lt;&lt;EOF </span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="co">#[*]</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="co">#default-cpus=1</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="co">#default-mem-mb=512</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="co">##max-cpus=2</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="co">#max-mem-mb=1024</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co">#EOF</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher.slurm.resources.conf<span class="op">&lt;&lt;</span>EOF</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>[small]</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Small (1 cpu, 8 GB mem)"</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">7627</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>[medium]</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Medium (2 cpu, 16 GB mem)"</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">2</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">15255</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>[large]</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Large (4 cpu, 32 GB mem)"</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">4</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">30511</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>[xlarge]</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Large (8 cpu, 64 GB mem)"</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">4</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">61022</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher.slurm.conf <span class="op">&lt;&lt;</span> EOF </span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable debugging</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>enable<span class="op">-</span>debug<span class="op">-</span>logging<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic configuration</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>slurm<span class="op">-</span>service<span class="op">-</span>user<span class="op">=</span>slurm</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>slurm<span class="op">-</span><span class="bu">bin</span><span class="op">-</span>path<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a><span class="co"># GPU specifics</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>enable<span class="op">-</span>gres<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a><span class="co">#gpu-types=v100</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>jupyter.conf <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>jupyter<span class="op">-</span>exe<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>notebooks<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>labs<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Install VSCode based on the PWB version.</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ( rstudio<span class="op">-</span>server <span class="op">|</span> grep configure<span class="op">-</span>vs<span class="op">-</span>code )<span class="op">;</span> then rstudio<span class="op">-</span>server configure<span class="op">-</span>vs<span class="op">-</span>code <span class="op">;</span> rstudio<span class="op">-</span>server install<span class="op">-</span>vs<span class="op">-</span>code<span class="op">-</span>ext<span class="op">;</span> <span class="cf">else</span> rstudio<span class="op">-</span>server install<span class="op">-</span>vs<span class="op">-</span>code <span class="op">/</span>opt<span class="op">/</span>rstudio<span class="op">/</span>vscode<span class="op">/;</span> fi</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>vscode.conf <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>exe<span class="op">=/</span>usr<span class="op">/</span>lib<span class="op">/</span>rstudio<span class="op">-</span>server<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>code<span class="op">-</span>server<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>code<span class="op">-</span>server</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>args<span class="op">=--</span>verbose <span class="op">--</span>host<span class="op">=</span><span class="fl">0.0.0.0</span> </span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sample user </span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">--</span>gid <span class="dv">8787</span> rstudio</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>useradd <span class="op">-</span>s <span class="op">/</span><span class="bu">bin</span><span class="op">/</span>bash <span class="op">-</span>m <span class="op">--</span>gid rstudio <span class="op">--</span>uid <span class="dv">8787</span> rstudio</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">--</span>gid <span class="dv">8788</span> rstudio<span class="op">-</span>admins</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">--</span>gid <span class="dv">8789</span> rstudio<span class="op">-</span>superuser<span class="op">-</span>admins</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>usermod <span class="op">-</span>G rstudio<span class="op">-</span>admins,rstudio<span class="op">-</span>superuser<span class="op">-</span>admins rstudio</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a><span class="co"># below SECRET string is a 10-digit random string that will be saved</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>rspasswd <span class="op">=</span> `tr <span class="op">-</span>dc A<span class="op">-</span>Za<span class="op">-</span>z0<span class="op">-</span><span class="dv">9</span> <span class="op">&lt;</span> <span class="op">/</span>dev<span class="op">/</span>urandom <span class="op">|</span> head <span class="op">-</span>c <span class="dv">10</span><span class="op">;</span> echo`</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>echo $rspasswd <span class="op">&gt;</span> <span class="op">/</span>home<span class="op">/</span>rstudio<span class="op">/</span>.rstudio<span class="op">-</span>pw</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>echo <span class="op">-</span>e <span class="st">"$rspasswd</span><span class="ch">\n</span><span class="st">$rspasswd"</span> <span class="op">|</span> passwd rstudio</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="couple-of-useful-tools" class="level4">
<h4 class="anchored" data-anchor-id="couple-of-useful-tools">Couple of useful tools</h4>
<div id="db32af95" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install a couple of useful tools</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>yum install <span class="op">-</span>y pciutils net<span class="op">-</span>tools nc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="systemctl-dependencies" class="level4">
<h4 class="anchored" data-anchor-id="systemctl-dependencies">systemctl dependencies</h4>
<p>A big part of the deployment is to ensure that the services are being started by <code>systemd</code> in the right order. For this, we tweak the systemd service definitions as follows:</p>
<ul>
<li><p><code>slurmdbd</code> reports it has started but the service is still starting up. This needs to be caught by a <code>ExecStartPost</code> script that keeps polling until the <code>slurmdbd</code> port is actually open.</p></li>
<li><p><code>slurmd</code> will only start properly if the nvidia driver has been loaded and the device <code>/dev/nvidia0</code> has been created.</p></li>
<li><p><code>nvidia-persistenced</code> ensures that the nvidia kernel module is loaded - it hence depends on <code>dkms</code> which on its own ensures the kernel module for nvidia is being recompiled for any new kernel.</p></li>
<li><p><code>rstudio-server</code> is only started after <code>rstudio-launcher</code> in order to avoid triggering any <code>Connection refused</code> messages from <code>rstudio-server</code>.</p></li>
<li><p><code>rstudio-server</code> will start only after <code>slurmctld</code> to ensure that SLURM Launcher is starting up properly.</p></li>
</ul>
<div id="3f177c49" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Structure systemctl order of running services</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=.*/After=dkms.service/'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>nvidia<span class="op">-</span>persistenced.service </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;slurmdbd.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmctld.service</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;slurmctld.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmd.service</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'/After=.*/a ConditionPathExists=\/dev\/nvidia0'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmd.service</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'/ExecReload=.*/a ExecStartPost=\/usr\/bin\/timeout 30 sh -c "while ! ss -H -t -l -n sport = \:6819 | grep -q ^LISTEN.*:6819; do sleep 1; done"'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmdbd.service</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;rstudio-launcher.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>rstudio<span class="op">-</span>server.service</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;slurmctld.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>rstudio<span class="op">-</span>launcher.service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="reboot" class="level4">
<h4 class="anchored" data-anchor-id="reboot">Reboot</h4>
<p>Finally we need to reboot the server in order to get the kernel module built and all the services started properly.</p>
<div id="5675c92c" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>reboot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/michaelmayer2\.github\.io\/gpu-slurm-single-node\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "GPU and SLURM with Posit Workbench"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Michael Mayer"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>With the ever increasing popularity of AI, more and more customers are exploring the use of GPU's with Posit Workbench. Many larger customers today have a Kubernetes or SLURM based Workbench environment for scalability. Those environments can be easily configured to allocate GPU's to Workbench sessions and general compute jobs as consumable resource.</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>Smaller to medium sized customers however sturggle a bit with the use of GPUs. In many cases they only can afford a single GPU on a server, many of them are still working on-prem but still want to make GPU computing available to their data scientists.</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>The below describes a possibility on how to configure a server with a single GPU so that it can be leveraged as a GPU server for a group of data scientists that can get shared access to the same GPU resources.</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>While the general description and all testing for this document was done on AWS, the same approach can easily be converted into an on-prem installation procedure.</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## General Information for our setup</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>For the detailed description below we will be using an AWS GPU instance and a standard AMI for Rocky Linux 9.3.</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>We will be using the AWS CLI tools to create a <span class="in">`p3.2xlarge`</span> instance with some user-data script. In this userdata script, <span class="co">[</span><span class="ot">R</span><span class="co">](https://docs.posit.co/resources/install-r/)</span>, <span class="co">[</span><span class="ot">Python</span><span class="co">](https://docs.posit.co/resources/install-python/)</span> and <span class="co">[</span><span class="ot">Workbench</span><span class="co">](https://docs.posit.co/ide/server-pro/getting_started/installation/installation.html#download-and-install)</span> will be installed using Posit provided binaries. SLURM will be compiled from source in the version specified.</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="fu">### AWS setup</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>First of all we need to define various parameters of our AWS account</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>| Parameter name | Description                                                       | Example                                                                                                                                               |</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>|------------------------|------------------------|------------------------|</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>| <span class="in">`VPC_ID`</span>       | ID of VPC to be used                                              | <span class="in">`vpc-1486376d`</span>                                                                                                                                        |</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>| <span class="in">`SUBNET_ID`</span>    | ID of a public subnet                                             | <span class="in">`subnet-cd7e8c86`</span>                                                                                                                                     |</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>| <span class="in">`AMI_ID`</span>       | ID of an AWS AMI that contains Rocky Linux 9                      | <span class="in">`ami-05a40a9d755b0f73a`</span>                                                                                                                               |</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>| <span class="in">`KEY_PAIR`</span>     | Name of SSH key pair to be used for logging into the EC2 instance | <span class="in">`michael.mayer@posit.co-keypair-for-pulumi`</span>                                                                                                           |</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>| <span class="in">`POSIT_TAGS`</span>   | Tags to be used for AWS resource cretion                          | <span class="in">`"{Key=rs:project,Value=solutions}, \             {Key=rs:environment,Value=development}, \             {Key=rs:owner,Value=michael.mayer@posit.co}"`</span> |</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>Once those parameters are defined we can create a security group to allow ingress on port 22 (ssh) and 8787 (workbench)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>SG_ID<span class="op">=</span>`aws ec2 create<span class="op">-</span>security<span class="op">-</span>group <span class="op">\</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>group<span class="op">-</span>name ssh<span class="op">-</span>wb<span class="op">-</span>sg <span class="op">\</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>description <span class="st">"SG for Workbench (port 8787) and SSH (port 22) access"</span> \</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>tag<span class="op">-</span>specifications <span class="st">"ResourceType=security-group,</span><span class="ch">\</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="st">        Tags=[{Key=Name,Value=ssh-wb-sg},$</span><span class="sc">{POSIT_TAGS}</span><span class="st">]"</span> \</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>vpc<span class="op">-</span><span class="bu">id</span> <span class="st">"$</span><span class="sc">{VPC_ID}</span><span class="st">"</span> <span class="op">|</span> jq <span class="op">-</span>r <span class="st">'.GroupId'</span> `</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>aws ec2 authorize<span class="op">-</span>security<span class="op">-</span>group<span class="op">-</span>ingress <span class="op">\</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>group<span class="op">-</span><span class="bu">id</span> <span class="st">"$</span><span class="sc">{SG_ID}</span><span class="st">"</span> \</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>protocol tcp <span class="op">\</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>port <span class="dv">8787</span> <span class="op">\</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>cidr <span class="st">"0.0.0.0/0"</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>aws ec2 authorize<span class="op">-</span>security<span class="op">-</span>group<span class="op">-</span>ingress <span class="op">\</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>group<span class="op">-</span><span class="bu">id</span> <span class="st">"$</span><span class="sc">{SG_ID}</span><span class="st">"</span> \</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>protocol tcp <span class="op">\</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>port <span class="dv">22</span> <span class="op">\</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>cidr <span class="st">"0.0.0.0/0"</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>and finally we can create the EC2 instance via</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>aws ec2 run<span class="op">-</span>instances <span class="op">\</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>image<span class="op">-</span><span class="bu">id</span> $AMI_ID <span class="op">\</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>count <span class="dv">1</span> <span class="op">\</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>instance<span class="op">-</span><span class="bu">type</span> p3<span class="fl">.2</span><span class="er">xlarge</span> <span class="op">\</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>key<span class="op">-</span>name $KEY_PAIR <span class="op">\</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>security<span class="op">-</span>group<span class="op">-</span>ids $SG_ID <span class="op">\</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>block<span class="op">-</span>device<span class="op">-</span>mappings <span class="st">"[{</span><span class="ch">\"</span><span class="st">DeviceName</span><span class="ch">\"</span><span class="st">:</span><span class="ch">\"</span><span class="st">/dev/sda1</span><span class="ch">\"</span><span class="st">,</span><span class="ch">\"</span><span class="st">Ebs</span><span class="ch">\"</span><span class="st">:{</span><span class="ch">\"</span><span class="st">VolumeSize</span><span class="ch">\"</span><span class="st">:100,</span><span class="ch">\"</span><span class="st">DeleteOnTermination</span><span class="ch">\"</span><span class="st">:true</span><span class="sc">}}</span><span class="st">]"</span> \</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>tag<span class="op">-</span>specifications <span class="st">"ResourceType=instance,Tags=[{Key=Name,Value=rl9-gpu},$</span><span class="sc">{POSIT_TAGS}</span><span class="st">]"</span> <span class="st">'ResourceType=volume,Tags=[{Key=Name,Value=rl9-gpu-disk}]'</span> \</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>user<span class="op">-</span>data <span class="bu">file</span>:<span class="op">//</span>${PWD}<span class="op">/</span>user<span class="op">-</span>data.sh</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>In your EC2 console you then will be able to see a new server with Name <span class="in">`rl9-gpu`</span> appearing - once it is up and running, you can connect to it to check progress. Please note the server will reboot once before fully ready. This is needed to rebuild the nvidia kernel modules for the linux kernel.</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="fu">### user-data script</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Introduction and Overview</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>| Parameter name        | Description                             | Default value                     |</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>|------------------------|------------------------|------------------------|</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>| <span class="in">`R_VERSION_LIST`</span>      | List of R versions to be installed      | <span class="in">`"3.6.3 4.0.5 4.1.3 4.2.3 4.3.3"`</span> |</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>| <span class="in">`PYTHON_VERSION_LIST`</span> | List of Python versions to be installed | <span class="in">`"3.8.19 3.9.19 3.10.14 3.11.8"`</span>  |</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>| <span class="in">`SLURM_VERSION`</span>       | Version of SLURM to be used             | <span class="in">`23.11.5-1`</span>                       |</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>| <span class="in">`PWB_VERSION`</span>         | Version of Posit Workbench to be used   | <span class="in">`2024.04.0-daily-675.pro4`</span>        |</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>All of the above parameters can be modified at the start to the user-data script.</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a><span class="fu">#### SELinux</span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>First, we will turn SELinux into permissive mode - this is needed for Workbench to run properly (mainly issues in Launcher)</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>setenforce permissive</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/^SELINUX=.*/SELINUX=permissive/'</span> <span class="op">/</span>etc<span class="op">/</span>sysconfig<span class="op">/</span>selinux </span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/^SELINUX=.*/SELINUX=permissive/'</span> <span class="op">/</span>etc<span class="op">/</span>selinux<span class="op">/</span>config</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>grubby <span class="op">--</span>update<span class="op">-</span>kernel ALL <span class="op">--</span>args selinux<span class="op">=</span>permissive</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Configuring the GPU</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>This is described in great detail at <span class="co">[</span><span class="ot">NVIDIA docs</span><span class="co">](https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#network-repo-installation-for-rhel-9-rocky-9)</span>. It will install the NVIDIA driver (550 series) and CUDA 12.4.</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y <span class="st">'dnf-command(config-manager)'</span> epel<span class="op">-</span>release</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>crb enable</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>dnf config<span class="op">-</span>manager <span class="op">--</span>add<span class="op">-</span>repo <span class="op">\</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>  https:<span class="op">//</span>developer.download.nvidia.com<span class="op">/</span>compute<span class="op">/</span>cuda<span class="op">/</span>repos<span class="op">/</span>rhel9<span class="op">/</span>x86_64<span class="op">/</span>cuda<span class="op">-</span>rhel9.repo</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>dnf clean expire<span class="op">-</span>cache</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y dkms</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>dnf module install <span class="op">-</span>y nvidia<span class="op">-</span>driver:<span class="dv">550</span></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y cuda<span class="op">-</span>toolkit<span class="op">-</span><span class="dv">12</span><span class="op">-</span><span class="dv">4</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y libcudnn8</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>etc<span class="op">/</span>profile.d<span class="op">/</span>cuda.sh</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>export PATH<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span>cuda<span class="op">/</span><span class="bu">bin</span>:\$PATH</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>export LD_LIBRARY_PATH<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span>cuda<span class="op">/</span>lib64:\$LD_LIBRARY_PATH</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>The above command will download about 5 GB of data. It will additionally install <span class="in">`libcudnn8`</span> and set both <span class="in">`PATH`</span> and <span class="in">`LD_LIBRARY_PATH`</span> so that the CUDA tools are usable. The <span class="in">`libcudnn8`</span> and <span class="in">`LD_LIBRARY_PATH`</span> are important to make <span class="co">[</span><span class="ot">TensorFlow 2.16.1 work</span><span class="co">](https://github.com/tensorflow/tensorflow/issues/63362)</span>.</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Setting up R</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>We will install a list of <span class="co">[</span><span class="ot">R versions</span><span class="co">](https://docs.posit.co/resources/install-r/)</span> and configure each for Java support.</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>export R_VERSION_LIST<span class="op">=</span><span class="st">"3.6.3 4.0.5 4.1.3 4.2.3 4.3.3"</span></span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a><span class="co"># While CUDA seems to prefer JAVA 11, Binary R packages are typically compiled with Java 8 only. </span></span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>dnf <span class="op">-</span>y install java<span class="op">-</span><span class="fl">1.8.0</span><span class="op">-</span>openjdk<span class="op">-</span>devel</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>curl <span class="op">-</span>O  https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>sol<span class="op">-</span>eng<span class="op">/</span>singularity<span class="op">-</span>rstudio<span class="op">/</span>main<span class="op">/</span>data<span class="op">/</span>r<span class="op">-</span>session<span class="op">-</span>complete<span class="op">/</span>centos7<span class="op">/</span>scripts<span class="op">/</span>run.R</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>curl <span class="op">-</span>O  https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>sol<span class="op">-</span>eng<span class="op">/</span>singularity<span class="op">-</span>rstudio<span class="op">/</span>main<span class="op">/</span>data<span class="op">/</span>r<span class="op">-</span>session<span class="op">-</span>complete<span class="op">/</span>centos7<span class="op">/</span>scripts<span class="op">/</span>bioc.txt</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> R_VERSION <span class="kw">in</span> $R_VERSION_LIST<span class="op">;</span> do yum install <span class="op">-</span>y https:<span class="op">//</span>cdn.rstudio.com<span class="op">/</span>r<span class="op">/</span>rhel<span class="op">-</span><span class="dv">9</span><span class="op">/</span>pkgs<span class="op">/</span>R<span class="op">-</span>${R_VERSION}<span class="op">-</span><span class="dv">1</span><span class="op">-</span><span class="fl">1.</span><span class="er">x86_64</span>.rpm<span class="op">;</span> done</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> R_VERSION <span class="kw">in</span> $R_VERSION_LIST<span class="op">;</span> do <span class="op">\</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>        export PATH<span class="op">=/</span>opt<span class="op">/</span>R<span class="op">/</span>$R_VERSION<span class="op">/</span><span class="bu">bin</span>:$PATH <span class="op">&amp;&amp;</span> <span class="op">\</span></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>        export JAVA_HOME<span class="op">=/</span>usr<span class="op">/</span>lib<span class="op">/</span>jvm<span class="op">/</span>java<span class="op">-</span><span class="fl">1.8.0</span><span class="op">-</span>openjdk<span class="op">/</span> <span class="op">&amp;&amp;</span> <span class="op">\</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>opt<span class="op">/</span>R<span class="op">/</span>${R_VERSION}<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>R CMD javareconf </span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Setting up Python</span></span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>We will install a list of <span class="co">[</span><span class="ot">Python versions</span><span class="co">](https://docs.posit.co/resources/install-python/)</span> and configure JupyterLab for the last python version mentioned in <span class="in">`PYTHON_VERSION_LIST`</span>.</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Python installation </span></span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $PYTHON_VERSION_LIST ]<span class="op">;</span> then PYTHON_VERSION_LIST<span class="op">=</span><span class="st">"3.8.19 3.9.19 3.10.14 3.11.8"</span><span class="op">;</span> fi</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> PYTHON_VERSION <span class="kw">in</span> $PYTHON_VERSION_LIST</span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>do</span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>    yum install <span class="op">-</span>y https:<span class="op">//</span>cdn.rstudio.com<span class="op">/</span>python<span class="op">/</span>rhel<span class="op">-</span><span class="dv">9</span><span class="op">/</span>pkgs<span class="op">/</span>python<span class="op">-</span>${PYTHON_VERSION}<span class="op">-</span><span class="dv">1</span><span class="op">-</span><span class="fl">1.</span><span class="er">x86_64</span>.rpm</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>done</span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Python version to be used for jupyter install (last one of PYTHON_VERSION_LIST)</span></span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>TMPVAR<span class="op">=</span>($PYTHON_VERSION_LIST)</span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>PYTHON_VERSION<span class="op">=</span>${TMPVAR[<span class="op">@</span>]: <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="co"># JupyterLab Version selected </span></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>JUPYTERLAB_VERSION<span class="op">=</span><span class="fl">3.6.5</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span><span class="st">"$</span><span class="sc">{PYTHON_VERSION}</span><span class="st">"</span><span class="op">/</span><span class="bu">bin</span><span class="op">/</span>python <span class="op">-</span>m venv <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter <span class="op">\</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>pip install <span class="op">\</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>      jupyter <span class="op">\</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>      jupyterlab<span class="op">==</span><span class="st">"$</span><span class="sc">{JUPYTERLAB_VERSION}</span><span class="st">"</span> \</span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>      rsconnect_jupyter <span class="op">\</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>      rsconnect_python <span class="op">\</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>      rsp_jupyter <span class="op">\</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>      workbench_jupyterlab <span class="op">\</span></span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> ln <span class="op">-</span>s <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter <span class="op">\</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension install <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsp_jupyter <span class="op">\</span></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension enable <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsp_jupyter <span class="op">\</span></span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension install <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsconnect_jupyter <span class="op">\</span></span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>nbextension enable <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsconnect_jupyter <span class="op">\</span></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">/</span>opt<span class="op">/</span>python<span class="op">/</span>jupyter<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter<span class="op">-</span>serverextension enable <span class="op">--</span>sys<span class="op">-</span>prefix <span class="op">--</span>py rsconnect_jupyter</span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Building SLURM from sources</span></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>We will build SLURM from source to ensure we can use the latest version and do not depend on any OS vendor to package SLURM. The minimum version of SLURM we can use is SLURM 22.x due to our use of <span class="co">[</span><span class="ot">Sharding</span><span class="co">](https://slurm.schedmd.com/gres.html#Sharding)</span>.</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a>The SLURM config uses</span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Prefix <span class="in">`/usr/local`</span></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>CLI binaries in <span class="in">`/usr/local/bin`</span> (Note the script to expand <span class="in">`PATH`</span> below)</span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`slurm.conf`</span> in <span class="in">`/usr/local/etc/slurm`</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- --&gt;</span></span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>external accounting DB (MariaDB)</span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>MUNGE authentication</span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`cgroups`</span> for cpus, memory and devices (e.g. GPUs)</span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>all log files are collected in <span class="in">`/var/log/slurm/`</span></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`gres.conf`</span> for our GPU and 8 shards.</span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $SLURM_VERSION ]<span class="op">;</span> then export SLURM_VERSION<span class="op">=</span><span class="fl">23.11.5</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y git</span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">-</span>r <span class="op">--</span>gid<span class="op">=</span><span class="dv">105</span> munge</span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a>useradd <span class="op">-</span>r <span class="op">-</span>s <span class="op">/</span><span class="bu">bin</span><span class="op">/</span>bash <span class="op">-</span>g munge <span class="op">--</span>uid<span class="op">=</span><span class="dv">105</span> munge</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>dnf install <span class="op">-</span>y bash<span class="op">-</span>completion mariadb<span class="op">-</span>devel mariadb<span class="op">-</span>server hdf5<span class="op">-</span>devel munge munge<span class="op">-</span>devel dbus<span class="op">-</span>devel hwloc<span class="op">-</span>devel readline<span class="op">-</span>devel lua<span class="op">-</span>devel man2html</span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>f <span class="op">/</span>usr<span class="op">/</span>sbin<span class="op">/</span>create<span class="op">-</span>munge<span class="op">-</span>key ]<span class="op">;</span> then <span class="op">/</span>usr<span class="op">/</span>sbin<span class="op">/</span>create<span class="op">-</span>munge<span class="op">-</span>key <span class="op">;</span> <span class="cf">else</span> <span class="op">/</span>usr<span class="op">/</span>sbin<span class="op">/</span>mungekey <span class="op">-</span>c <span class="op">-</span>f<span class="op">;</span> fi</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>export SLURM_PREFIX<span class="op">=/</span>usr<span class="op">/</span>local</span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p $SLURM_PREFIX<span class="op">/</span>etc<span class="op">/</span>slurm <span class="op">&amp;&amp;</span> mkdir <span class="op">-</span>p <span class="op">/</span>tmp<span class="op">/</span>build <span class="op">&amp;&amp;</span> cd <span class="op">/</span>tmp<span class="op">/</span>build <span class="op">\</span></span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"git clone --depth 1 -b slurm-\${SLURM_VERSION//./-} https://github.com/SchedMD/slurm.git"</span> \</span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> cd slurm <span class="op">\</span></span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> echo <span class="st">"Configuring SLURM $</span><span class="sc">{SLURM_VERSION}</span><span class="st">"</span> \</span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"./configure --enable-debug --prefix=$SLURM_PREFIX --sysconfdir=$SLURM_PREFIX/etc/slurm </span><span class="ch">\</span></span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a><span class="st">        --with-mysql_config=/usr/bin  --libdir=$SLURM_PREFIX/lib64 --with-systemdsystemunitdir=/usr/lib/systemd/system/ &gt;&amp; $SLURM_PREFIX/etc/slurm/.configure.log"</span>  \</span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> echo <span class="st">"Building SLURM $</span><span class="sc">{SLURM_VERSION}</span><span class="st">"</span> \</span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"make -j 8 &gt;&amp; $SLURM_PREFIX/etc/slurm/.build.log"</span> \</span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> echo <span class="st">"Installing SLURM $</span><span class="sc">{SLURM_VERSION}</span><span class="st">"</span> \</span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> bash <span class="op">-</span>c <span class="st">"make -j 8 install &gt;&amp; $SLURM_PREFIX/etc/slurm/.install.log"</span> \</span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> install <span class="op">-</span>D <span class="op">-</span>m644 contribs<span class="op">/</span>slurm_completion_help<span class="op">/</span>slurm_completion.sh <span class="op">/</span>etc<span class="op">/</span>profile.d<span class="op">/</span>slurm_completion.sh <span class="op">\</span></span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> cd .. <span class="op">\</span></span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> rm <span class="op">-</span>rf slurm <span class="op">\</span></span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> groupadd <span class="op">-</span>r <span class="op">--</span>gid<span class="op">=</span><span class="dv">980</span> slurm <span class="op">\</span></span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> useradd <span class="op">-</span>r <span class="op">-</span>g slurm <span class="op">--</span>uid<span class="op">=</span><span class="dv">985</span> slurm <span class="op">\</span></span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> mkdir <span class="op">-</span>p <span class="op">/</span>etc<span class="op">/</span>sysconfig<span class="op">/</span>slurm <span class="op">\</span></span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmd <span class="op">\</span></span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>run<span class="op">/</span>slurm <span class="op">\</span></span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>run<span class="op">/</span>slurmdbd <span class="op">\</span></span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>lib<span class="op">/</span>slurmd <span class="op">\</span></span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>log<span class="op">/</span>slurm <span class="op">\</span></span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmctld <span class="op">\</span></span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> chown <span class="op">-</span>R slurm:slurm <span class="op">/</span>var<span class="op">/*/</span>slurm<span class="op">*</span></span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure /usr/local/bin is in $PATH</span></span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"export PATH=/usr/local/bin:\$PATH"</span> <span class="op">&gt;</span> <span class="op">/</span>etc<span class="op">/</span>profile.d<span class="op">/</span>path<span class="op">-</span>usr<span class="op">-</span>local.sh</span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure mariadb</span></span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a>systemctl enable mariadb</span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a>systemctl start mariadb</span>
<span id="cb12-266"><a href="#cb12-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-267"><a href="#cb12-267" aria-hidden="true" tabindex="-1"></a>mysql_secure_installation <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a>Testme1234</span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a>Testme1234</span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a>Y</span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-278"><a href="#cb12-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-279"><a href="#cb12-279" aria-hidden="true" tabindex="-1"></a><span class="co"># SLURM configuration</span></span>
<span id="cb12-280"><a href="#cb12-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-281"><a href="#cb12-281" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span></span>
<span id="cb12-282"><a href="#cb12-282" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurm.conf</span>
<span id="cb12-283"><a href="#cb12-283" aria-hidden="true" tabindex="-1"></a>ClusterName<span class="op">=</span>pwb</span>
<span id="cb12-284"><a href="#cb12-284" aria-hidden="true" tabindex="-1"></a>SlurmctldHost<span class="op">=</span>localhost</span>
<span id="cb12-285"><a href="#cb12-285" aria-hidden="true" tabindex="-1"></a>ProctrackType<span class="op">=</span>proctrack<span class="op">/</span>cgroup</span>
<span id="cb12-286"><a href="#cb12-286" aria-hidden="true" tabindex="-1"></a>ReturnToService<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-287"><a href="#cb12-287" aria-hidden="true" tabindex="-1"></a>SlurmctldPidFile<span class="op">=/</span>var<span class="op">/</span>run<span class="op">/</span>slurm<span class="op">/</span>slurmctld.pid</span>
<span id="cb12-288"><a href="#cb12-288" aria-hidden="true" tabindex="-1"></a>SlurmctldPort<span class="op">=</span><span class="dv">6817</span></span>
<span id="cb12-289"><a href="#cb12-289" aria-hidden="true" tabindex="-1"></a>SlurmdPidFile<span class="op">=/</span>var<span class="op">/</span>run<span class="op">/</span>slurm<span class="op">/</span>slurmd.pid</span>
<span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a>SlurmdPort<span class="op">=</span><span class="dv">6818</span></span>
<span id="cb12-291"><a href="#cb12-291" aria-hidden="true" tabindex="-1"></a>SlurmdSpoolDir<span class="op">=/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmd</span>
<span id="cb12-292"><a href="#cb12-292" aria-hidden="true" tabindex="-1"></a>SlurmUser<span class="op">=</span>slurm</span>
<span id="cb12-293"><a href="#cb12-293" aria-hidden="true" tabindex="-1"></a>StateSaveLocation<span class="op">=/</span>var<span class="op">/</span>spool<span class="op">/</span>slurmctld</span>
<span id="cb12-294"><a href="#cb12-294" aria-hidden="true" tabindex="-1"></a>TaskPlugin<span class="op">=</span>task<span class="op">/</span>affinity,task<span class="op">/</span>cgroup</span>
<span id="cb12-295"><a href="#cb12-295" aria-hidden="true" tabindex="-1"></a>InactiveLimit<span class="op">=</span><span class="dv">0</span></span>
<span id="cb12-296"><a href="#cb12-296" aria-hidden="true" tabindex="-1"></a>KillWait<span class="op">=</span><span class="dv">30</span></span>
<span id="cb12-297"><a href="#cb12-297" aria-hidden="true" tabindex="-1"></a>MinJobAge<span class="op">=</span><span class="dv">300</span></span>
<span id="cb12-298"><a href="#cb12-298" aria-hidden="true" tabindex="-1"></a>SlurmctldTimeout<span class="op">=</span><span class="dv">120</span></span>
<span id="cb12-299"><a href="#cb12-299" aria-hidden="true" tabindex="-1"></a>SlurmdTimeout<span class="op">=</span><span class="dv">300</span></span>
<span id="cb12-300"><a href="#cb12-300" aria-hidden="true" tabindex="-1"></a>Waittime<span class="op">=</span><span class="dv">0</span></span>
<span id="cb12-301"><a href="#cb12-301" aria-hidden="true" tabindex="-1"></a>SchedulerType<span class="op">=</span>sched<span class="op">/</span>backfill</span>
<span id="cb12-302"><a href="#cb12-302" aria-hidden="true" tabindex="-1"></a>SelectType<span class="op">=</span>select<span class="op">/</span>cons_tres</span>
<span id="cb12-303"><a href="#cb12-303" aria-hidden="true" tabindex="-1"></a>AccountingStorageType<span class="op">=</span>accounting_storage<span class="op">/</span>slurmdbd</span>
<span id="cb12-304"><a href="#cb12-304" aria-hidden="true" tabindex="-1"></a>AccountingStorageTRES<span class="op">=</span>gres<span class="op">/</span>gpu,gres<span class="op">/</span>shard</span>
<span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>GresTypes<span class="op">=</span>gpu,shard</span>
<span id="cb12-306"><a href="#cb12-306" aria-hidden="true" tabindex="-1"></a>JobCompType<span class="op">=</span>jobcomp<span class="op">/</span>none</span>
<span id="cb12-307"><a href="#cb12-307" aria-hidden="true" tabindex="-1"></a>JobAcctGatherFrequency<span class="op">=</span><span class="dv">10</span></span>
<span id="cb12-308"><a href="#cb12-308" aria-hidden="true" tabindex="-1"></a>SlurmctldDebug<span class="op">=</span>info</span>
<span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a>SlurmctldLogFile<span class="op">=/</span>var<span class="op">/</span>log<span class="op">/</span>slurm<span class="op">/</span>slurmctld.log</span>
<span id="cb12-310"><a href="#cb12-310" aria-hidden="true" tabindex="-1"></a>SlurmdDebug<span class="op">=</span>info</span>
<span id="cb12-311"><a href="#cb12-311" aria-hidden="true" tabindex="-1"></a>SlurmdLogFile<span class="op">=/</span>var<span class="op">/</span>log<span class="op">/</span>slurm<span class="op">/</span>slurmd.log</span>
<span id="cb12-312"><a href="#cb12-312" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost CPUs=8 SocketsPerBoard=1 CoresPerSocket=4 ThreadsPerCore=1 Gres=gpu:1,shard:8 State=UNKNOWN</span></span>
<span id="cb12-313"><a href="#cb12-313" aria-hidden="true" tabindex="-1"></a>NodeName<span class="op">=</span>localhost CPUs<span class="op">=</span><span class="dv">8</span> Boards<span class="op">=</span><span class="dv">1</span> Gres<span class="op">=</span>gpu:v100:<span class="dv">1</span>,shard:<span class="dv">8</span> SocketsPerBoard<span class="op">=</span><span class="dv">1</span> CoresPerSocket<span class="op">=</span><span class="dv">4</span> ThreadsPerCore<span class="op">=</span><span class="dv">2</span> RealMemory<span class="op">=</span><span class="dv">61022</span> State<span class="op">=</span>UNKNOWN</span>
<span id="cb12-314"><a href="#cb12-314" aria-hidden="true" tabindex="-1"></a>PartitionName<span class="op">=</span><span class="bu">all</span> Nodes<span class="op">=</span>ALL Default<span class="op">=</span>YES MaxTime<span class="op">=</span>INFINITE State<span class="op">=</span>UP</span>
<span id="cb12-315"><a href="#cb12-315" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-316"><a href="#cb12-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-317"><a href="#cb12-317" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.conf</span>
<span id="cb12-318"><a href="#cb12-318" aria-hidden="true" tabindex="-1"></a>AuthType<span class="op">=</span>auth<span class="op">/</span>munge</span>
<span id="cb12-319"><a href="#cb12-319" aria-hidden="true" tabindex="-1"></a>LogFile<span class="op">=/</span>var<span class="op">/</span>log<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.log</span>
<span id="cb12-320"><a href="#cb12-320" aria-hidden="true" tabindex="-1"></a>PidFile<span class="op">=/</span>var<span class="op">/</span>run<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.pid</span>
<span id="cb12-321"><a href="#cb12-321" aria-hidden="true" tabindex="-1"></a>DbdPort<span class="op">=</span><span class="dv">6819</span></span>
<span id="cb12-322"><a href="#cb12-322" aria-hidden="true" tabindex="-1"></a>SlurmUser<span class="op">=</span>slurm</span>
<span id="cb12-323"><a href="#cb12-323" aria-hidden="true" tabindex="-1"></a>StorageType<span class="op">=</span>accounting_storage<span class="op">/</span>mysql</span>
<span id="cb12-324"><a href="#cb12-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-325"><a href="#cb12-325" aria-hidden="true" tabindex="-1"></a>DbdHost<span class="op">=</span>localhost</span>
<span id="cb12-326"><a href="#cb12-326" aria-hidden="true" tabindex="-1"></a>StorageHost<span class="op">=</span>localhost</span>
<span id="cb12-327"><a href="#cb12-327" aria-hidden="true" tabindex="-1"></a>StoragePort<span class="op">=</span><span class="dv">3306</span></span>
<span id="cb12-328"><a href="#cb12-328" aria-hidden="true" tabindex="-1"></a>StorageLoc<span class="op">=</span>slurm</span>
<span id="cb12-329"><a href="#cb12-329" aria-hidden="true" tabindex="-1"></a>StorageUser<span class="op">=</span>root</span>
<span id="cb12-330"><a href="#cb12-330" aria-hidden="true" tabindex="-1"></a>StoragePass<span class="op">=</span>Testme1234</span>
<span id="cb12-331"><a href="#cb12-331" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-332"><a href="#cb12-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-333"><a href="#cb12-333" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>gres.conf</span>
<span id="cb12-334"><a href="#cb12-334" aria-hidden="true" tabindex="-1"></a>AutoDetect<span class="op">=</span>off</span>
<span id="cb12-335"><a href="#cb12-335" aria-hidden="true" tabindex="-1"></a>NodeName<span class="op">=</span>localhost Name<span class="op">=</span>gpu Type<span class="op">=</span>v100 File<span class="op">=/</span>dev<span class="op">/</span>nvidia0</span>
<span id="cb12-336"><a href="#cb12-336" aria-hidden="true" tabindex="-1"></a>NodeName<span class="op">=</span>localhost Name<span class="op">=</span>shard Count<span class="op">=</span><span class="dv">8</span></span>
<span id="cb12-337"><a href="#cb12-337" aria-hidden="true" tabindex="-1"></a><span class="co">#p3.8xlarge</span></span>
<span id="cb12-338"><a href="#cb12-338" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia0</span></span>
<span id="cb12-339"><a href="#cb12-339" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia1</span></span>
<span id="cb12-340"><a href="#cb12-340" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia3</span></span>
<span id="cb12-341"><a href="#cb12-341" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=gpu Type=v100 File=/dev/nvidia2</span></span>
<span id="cb12-342"><a href="#cb12-342" aria-hidden="true" tabindex="-1"></a><span class="co">#NodeName=localhost Name=shard Count=8</span></span>
<span id="cb12-343"><a href="#cb12-343" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-344"><a href="#cb12-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-345"><a href="#cb12-345" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&lt;&lt;</span> EOF <span class="op">&gt;</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>cgroup.conf</span>
<span id="cb12-346"><a href="#cb12-346" aria-hidden="true" tabindex="-1"></a>ConstrainCores<span class="op">=</span>yes</span>
<span id="cb12-347"><a href="#cb12-347" aria-hidden="true" tabindex="-1"></a>ConstrainDevices<span class="op">=</span>yes</span>
<span id="cb12-348"><a href="#cb12-348" aria-hidden="true" tabindex="-1"></a>ConstrainRAMSpace<span class="op">=</span>yes</span>
<span id="cb12-349"><a href="#cb12-349" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-350"><a href="#cb12-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-351"><a href="#cb12-351" aria-hidden="true" tabindex="-1"></a>chown slurm <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.conf</span>
<span id="cb12-352"><a href="#cb12-352" aria-hidden="true" tabindex="-1"></a>chmod <span class="dv">0</span><span class="er">600</span> <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm<span class="op">/</span>slurmdbd.conf</span>
<span id="cb12-353"><a href="#cb12-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-354"><a href="#cb12-354" aria-hidden="true" tabindex="-1"></a>systemctl enable munge</span>
<span id="cb12-355"><a href="#cb12-355" aria-hidden="true" tabindex="-1"></a>systemctl enable slurmctld </span>
<span id="cb12-356"><a href="#cb12-356" aria-hidden="true" tabindex="-1"></a>systemctl enable slurmdbd</span>
<span id="cb12-357"><a href="#cb12-357" aria-hidden="true" tabindex="-1"></a>systemctl enable slurmd</span>
<span id="cb12-358"><a href="#cb12-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-359"><a href="#cb12-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-360"><a href="#cb12-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-361"><a href="#cb12-361" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Install and configure Workbench</span></span>
<span id="cb12-362"><a href="#cb12-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-363"><a href="#cb12-363" aria-hidden="true" tabindex="-1"></a>Workbench will be configured for SLURM Launcher with GRES support only. This will allow the user to specify <span class="in">`shard:X`</span> as GRES where X can run from 1 to 8. CPU and memory resources have been set up so that they are making most efficient use of the available CPUs and memory.</span>
<span id="cb12-364"><a href="#cb12-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-365"><a href="#cb12-365" aria-hidden="true" tabindex="-1"></a>We also will configure support for all 4 IDE's, e.g. RStudio IDE, VS Code, Jupyter Notebooks and JupyterLab. A user named <span class="in">`rstudio`</span> is created that has all admin privileges on Workbench. A random 10-digit password will be assigned and saved in a <span class="in">`.rstudio-pw`</span> file in the <span class="in">`rstudio`</span> users' home-directory.</span>
<span id="cb12-366"><a href="#cb12-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-369"><a href="#cb12-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-370"><a href="#cb12-370" aria-hidden="true" tabindex="-1"></a><span class="co"># Workbench installation </span></span>
<span id="cb12-371"><a href="#cb12-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-372"><a href="#cb12-372" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">-</span>z $PWB_VERSION ]<span class="op">;</span> then export PWB_VERSION<span class="op">=</span><span class="fl">2024.04.0</span><span class="op">-</span>daily<span class="op">-</span><span class="fl">675.</span><span class="er">pro4</span><span class="op">;</span> fi</span>
<span id="cb12-373"><a href="#cb12-373" aria-hidden="true" tabindex="-1"></a>yum <span class="op">-</span>y install https:<span class="op">//</span>s3.amazonaws.com<span class="op">/</span>rstudio<span class="op">-</span>ide<span class="op">-</span>build<span class="op">/</span>server<span class="op">/</span>rhel9<span class="op">/</span>x86_64<span class="op">/</span>rstudio<span class="op">-</span>workbench<span class="op">-</span>rhel<span class="op">-</span>${PWB_VERSION}<span class="op">-</span>x86_64.rpm</span>
<span id="cb12-374"><a href="#cb12-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-375"><a href="#cb12-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Workbench setup</span></span>
<span id="cb12-376"><a href="#cb12-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-377"><a href="#cb12-377" aria-hidden="true" tabindex="-1"></a>configdir<span class="op">=</span><span class="st">"/etc/rstudio"</span></span>
<span id="cb12-378"><a href="#cb12-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-379"><a href="#cb12-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Add SLURM integration </span></span>
<span id="cb12-380"><a href="#cb12-380" aria-hidden="true" tabindex="-1"></a>myip<span class="op">=</span>`curl http:<span class="op">//</span>checkip.amazonaws.com`</span>
<span id="cb12-381"><a href="#cb12-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-382"><a href="#cb12-382" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p <span class="op">/</span>opt<span class="op">/</span>rstudio<span class="op">/</span>shared<span class="op">-</span>storage</span>
<span id="cb12-383"><a href="#cb12-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-384"><a href="#cb12-384" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher<span class="op">-</span>env <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb12-385"><a href="#cb12-385" aria-hidden="true" tabindex="-1"></a>RSTUDIO_DISABLE_PACKAGE_INSTALL_PROMPT<span class="op">=</span>yes</span>
<span id="cb12-386"><a href="#cb12-386" aria-hidden="true" tabindex="-1"></a>SLURM_CONF<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span>etc<span class="op">/</span>slurm.conf</span>
<span id="cb12-387"><a href="#cb12-387" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-388"><a href="#cb12-388" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb12-389"><a href="#cb12-389" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>rserver.conf <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb12-390"><a href="#cb12-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-391"><a href="#cb12-391" aria-hidden="true" tabindex="-1"></a><span class="co"># Launcher Config</span></span>
<span id="cb12-392"><a href="#cb12-392" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>address<span class="op">=</span><span class="fl">127.0.0.1</span></span>
<span id="cb12-393"><a href="#cb12-393" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>port<span class="op">=</span><span class="dv">5559</span></span>
<span id="cb12-394"><a href="#cb12-394" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>sessions<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-395"><a href="#cb12-395" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>default<span class="op">-</span>cluster<span class="op">=</span>Slurm</span>
<span id="cb12-396"><a href="#cb12-396" aria-hidden="true" tabindex="-1"></a>launcher<span class="op">-</span>sessions<span class="op">-</span>callback<span class="op">-</span>address<span class="op">=</span>http:<span class="op">//</span>${myip}:<span class="dv">8787</span></span>
<span id="cb12-397"><a href="#cb12-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-398"><a href="#cb12-398" aria-hidden="true" tabindex="-1"></a><span class="co"># Disable R Versions scanning</span></span>
<span id="cb12-399"><a href="#cb12-399" aria-hidden="true" tabindex="-1"></a><span class="co">#r-versions-scan=0</span></span>
<span id="cb12-400"><a href="#cb12-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-401"><a href="#cb12-401" aria-hidden="true" tabindex="-1"></a>auth<span class="op">-</span>pam<span class="op">-</span>sessions<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-402"><a href="#cb12-402" aria-hidden="true" tabindex="-1"></a>auth<span class="op">-</span>pam<span class="op">-</span>sessions<span class="op">-</span>use<span class="op">-</span>password<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-403"><a href="#cb12-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-404"><a href="#cb12-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable Admin Dashboard</span></span>
<span id="cb12-405"><a href="#cb12-405" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-406"><a href="#cb12-406" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>group<span class="op">=</span>rstudio<span class="op">-</span>admins</span>
<span id="cb12-407"><a href="#cb12-407" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>superuser<span class="op">-</span>group<span class="op">=</span>rstudio<span class="op">-</span>superuser<span class="op">-</span>admins</span>
<span id="cb12-408"><a href="#cb12-408" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>monitor<span class="op">-</span>log<span class="op">-</span>use<span class="op">-</span>server<span class="op">-</span>time<span class="op">-</span>zone<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-409"><a href="#cb12-409" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>console<span class="op">-</span>user<span class="op">-</span>limit<span class="op">-</span>mb<span class="op">=</span><span class="dv">200</span></span>
<span id="cb12-410"><a href="#cb12-410" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>console<span class="op">-</span>user<span class="op">-</span>limit<span class="op">-</span>months<span class="op">=</span><span class="dv">3</span></span>
<span id="cb12-411"><a href="#cb12-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-412"><a href="#cb12-412" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable Auditing</span></span>
<span id="cb12-413"><a href="#cb12-413" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>console<span class="op">=</span><span class="bu">all</span></span>
<span id="cb12-414"><a href="#cb12-414" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>sessions<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-415"><a href="#cb12-415" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>sessions<span class="op">-</span>limit<span class="op">-</span>mb<span class="op">=</span><span class="dv">512</span></span>
<span id="cb12-416"><a href="#cb12-416" aria-hidden="true" tabindex="-1"></a>audit<span class="op">-</span>r<span class="op">-</span>sessions<span class="op">-</span>limit<span class="op">-</span>months<span class="op">=</span><span class="dv">6</span></span>
<span id="cb12-417"><a href="#cb12-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-418"><a href="#cb12-418" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-419"><a href="#cb12-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-420"><a href="#cb12-420" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher.conf<span class="op">&lt;&lt;</span>EOF</span>
<span id="cb12-421"><a href="#cb12-421" aria-hidden="true" tabindex="-1"></a>[server]</span>
<span id="cb12-422"><a href="#cb12-422" aria-hidden="true" tabindex="-1"></a>address<span class="op">=</span><span class="fl">127.0.0.1</span></span>
<span id="cb12-423"><a href="#cb12-423" aria-hidden="true" tabindex="-1"></a>port<span class="op">=</span><span class="dv">5559</span></span>
<span id="cb12-424"><a href="#cb12-424" aria-hidden="true" tabindex="-1"></a>server<span class="op">-</span>user<span class="op">=</span>rstudio<span class="op">-</span>server</span>
<span id="cb12-425"><a href="#cb12-425" aria-hidden="true" tabindex="-1"></a>admin<span class="op">-</span>group<span class="op">=</span>rstudio<span class="op">-</span>server</span>
<span id="cb12-426"><a href="#cb12-426" aria-hidden="true" tabindex="-1"></a>authorization<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-427"><a href="#cb12-427" aria-hidden="true" tabindex="-1"></a>thread<span class="op">-</span>pool<span class="op">-</span>size<span class="op">=</span><span class="dv">4</span></span>
<span id="cb12-428"><a href="#cb12-428" aria-hidden="true" tabindex="-1"></a>enable<span class="op">-</span>debug<span class="op">-</span>logging<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-429"><a href="#cb12-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-430"><a href="#cb12-430" aria-hidden="true" tabindex="-1"></a>[cluster]</span>
<span id="cb12-431"><a href="#cb12-431" aria-hidden="true" tabindex="-1"></a>name<span class="op">=</span>Slurm</span>
<span id="cb12-432"><a href="#cb12-432" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span><span class="op">=</span>Slurm</span>
<span id="cb12-433"><a href="#cb12-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-434"><a href="#cb12-434" aria-hidden="true" tabindex="-1"></a><span class="co">#[cluster]</span></span>
<span id="cb12-435"><a href="#cb12-435" aria-hidden="true" tabindex="-1"></a><span class="co">#name=Local</span></span>
<span id="cb12-436"><a href="#cb12-436" aria-hidden="true" tabindex="-1"></a><span class="co">#type=Local</span></span>
<span id="cb12-437"><a href="#cb12-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-438"><a href="#cb12-438" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-439"><a href="#cb12-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-440"><a href="#cb12-440" aria-hidden="true" tabindex="-1"></a><span class="co">#cat &gt; $configdir/launcher.slurm.profiles.conf&lt;&lt;EOF </span></span>
<span id="cb12-441"><a href="#cb12-441" aria-hidden="true" tabindex="-1"></a><span class="co">#[*]</span></span>
<span id="cb12-442"><a href="#cb12-442" aria-hidden="true" tabindex="-1"></a><span class="co">#default-cpus=1</span></span>
<span id="cb12-443"><a href="#cb12-443" aria-hidden="true" tabindex="-1"></a><span class="co">#default-mem-mb=512</span></span>
<span id="cb12-444"><a href="#cb12-444" aria-hidden="true" tabindex="-1"></a><span class="co">##max-cpus=2</span></span>
<span id="cb12-445"><a href="#cb12-445" aria-hidden="true" tabindex="-1"></a><span class="co">#max-mem-mb=1024</span></span>
<span id="cb12-446"><a href="#cb12-446" aria-hidden="true" tabindex="-1"></a><span class="co">#EOF</span></span>
<span id="cb12-447"><a href="#cb12-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-448"><a href="#cb12-448" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher.slurm.resources.conf<span class="op">&lt;&lt;</span>EOF</span>
<span id="cb12-449"><a href="#cb12-449" aria-hidden="true" tabindex="-1"></a>[small]</span>
<span id="cb12-450"><a href="#cb12-450" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Small (1 cpu, 8 GB mem)"</span></span>
<span id="cb12-451"><a href="#cb12-451" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-452"><a href="#cb12-452" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">7627</span></span>
<span id="cb12-453"><a href="#cb12-453" aria-hidden="true" tabindex="-1"></a>[medium]</span>
<span id="cb12-454"><a href="#cb12-454" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Medium (2 cpu, 16 GB mem)"</span></span>
<span id="cb12-455"><a href="#cb12-455" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">2</span></span>
<span id="cb12-456"><a href="#cb12-456" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">15255</span></span>
<span id="cb12-457"><a href="#cb12-457" aria-hidden="true" tabindex="-1"></a>[large]</span>
<span id="cb12-458"><a href="#cb12-458" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Large (4 cpu, 32 GB mem)"</span></span>
<span id="cb12-459"><a href="#cb12-459" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">4</span></span>
<span id="cb12-460"><a href="#cb12-460" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">30511</span></span>
<span id="cb12-461"><a href="#cb12-461" aria-hidden="true" tabindex="-1"></a>[xlarge]</span>
<span id="cb12-462"><a href="#cb12-462" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"Large (8 cpu, 64 GB mem)"</span></span>
<span id="cb12-463"><a href="#cb12-463" aria-hidden="true" tabindex="-1"></a>cpus<span class="op">=</span><span class="dv">4</span></span>
<span id="cb12-464"><a href="#cb12-464" aria-hidden="true" tabindex="-1"></a>mem<span class="op">-</span>mb<span class="op">=</span><span class="dv">61022</span></span>
<span id="cb12-465"><a href="#cb12-465" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-466"><a href="#cb12-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-467"><a href="#cb12-467" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>launcher.slurm.conf <span class="op">&lt;&lt;</span> EOF </span>
<span id="cb12-468"><a href="#cb12-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable debugging</span></span>
<span id="cb12-469"><a href="#cb12-469" aria-hidden="true" tabindex="-1"></a>enable<span class="op">-</span>debug<span class="op">-</span>logging<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-470"><a href="#cb12-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-471"><a href="#cb12-471" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic configuration</span></span>
<span id="cb12-472"><a href="#cb12-472" aria-hidden="true" tabindex="-1"></a>slurm<span class="op">-</span>service<span class="op">-</span>user<span class="op">=</span>slurm</span>
<span id="cb12-473"><a href="#cb12-473" aria-hidden="true" tabindex="-1"></a>slurm<span class="op">-</span><span class="bu">bin</span><span class="op">-</span>path<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span></span>
<span id="cb12-474"><a href="#cb12-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-475"><a href="#cb12-475" aria-hidden="true" tabindex="-1"></a><span class="co"># GPU specifics</span></span>
<span id="cb12-476"><a href="#cb12-476" aria-hidden="true" tabindex="-1"></a>enable<span class="op">-</span>gres<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-477"><a href="#cb12-477" aria-hidden="true" tabindex="-1"></a><span class="co">#gpu-types=v100</span></span>
<span id="cb12-478"><a href="#cb12-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-479"><a href="#cb12-479" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-480"><a href="#cb12-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-481"><a href="#cb12-481" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>jupyter.conf <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb12-482"><a href="#cb12-482" aria-hidden="true" tabindex="-1"></a>jupyter<span class="op">-</span>exe<span class="op">=/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>jupyter</span>
<span id="cb12-483"><a href="#cb12-483" aria-hidden="true" tabindex="-1"></a>notebooks<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-484"><a href="#cb12-484" aria-hidden="true" tabindex="-1"></a>labs<span class="op">-</span>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-485"><a href="#cb12-485" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-486"><a href="#cb12-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-487"><a href="#cb12-487" aria-hidden="true" tabindex="-1"></a><span class="co"># Install VSCode based on the PWB version.</span></span>
<span id="cb12-488"><a href="#cb12-488" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ( rstudio<span class="op">-</span>server <span class="op">|</span> grep configure<span class="op">-</span>vs<span class="op">-</span>code )<span class="op">;</span> then rstudio<span class="op">-</span>server configure<span class="op">-</span>vs<span class="op">-</span>code <span class="op">;</span> rstudio<span class="op">-</span>server install<span class="op">-</span>vs<span class="op">-</span>code<span class="op">-</span>ext<span class="op">;</span> <span class="cf">else</span> rstudio<span class="op">-</span>server install<span class="op">-</span>vs<span class="op">-</span>code <span class="op">/</span>opt<span class="op">/</span>rstudio<span class="op">/</span>vscode<span class="op">/;</span> fi</span>
<span id="cb12-489"><a href="#cb12-489" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-490"><a href="#cb12-490" aria-hidden="true" tabindex="-1"></a>cat <span class="op">&gt;</span> $configdir<span class="op">/</span>vscode.conf <span class="op">&lt;&lt;</span> EOF</span>
<span id="cb12-491"><a href="#cb12-491" aria-hidden="true" tabindex="-1"></a>enabled<span class="op">=</span><span class="dv">1</span></span>
<span id="cb12-492"><a href="#cb12-492" aria-hidden="true" tabindex="-1"></a>exe<span class="op">=/</span>usr<span class="op">/</span>lib<span class="op">/</span>rstudio<span class="op">-</span>server<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>code<span class="op">-</span>server<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>code<span class="op">-</span>server</span>
<span id="cb12-493"><a href="#cb12-493" aria-hidden="true" tabindex="-1"></a>args<span class="op">=--</span>verbose <span class="op">--</span>host<span class="op">=</span><span class="fl">0.0.0.0</span> </span>
<span id="cb12-494"><a href="#cb12-494" aria-hidden="true" tabindex="-1"></a>EOF</span>
<span id="cb12-495"><a href="#cb12-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-496"><a href="#cb12-496" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sample user </span></span>
<span id="cb12-497"><a href="#cb12-497" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">--</span>gid <span class="dv">8787</span> rstudio</span>
<span id="cb12-498"><a href="#cb12-498" aria-hidden="true" tabindex="-1"></a>useradd <span class="op">-</span>s <span class="op">/</span><span class="bu">bin</span><span class="op">/</span>bash <span class="op">-</span>m <span class="op">--</span>gid rstudio <span class="op">--</span>uid <span class="dv">8787</span> rstudio</span>
<span id="cb12-499"><a href="#cb12-499" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">--</span>gid <span class="dv">8788</span> rstudio<span class="op">-</span>admins</span>
<span id="cb12-500"><a href="#cb12-500" aria-hidden="true" tabindex="-1"></a>groupadd <span class="op">--</span>gid <span class="dv">8789</span> rstudio<span class="op">-</span>superuser<span class="op">-</span>admins</span>
<span id="cb12-501"><a href="#cb12-501" aria-hidden="true" tabindex="-1"></a>usermod <span class="op">-</span>G rstudio<span class="op">-</span>admins,rstudio<span class="op">-</span>superuser<span class="op">-</span>admins rstudio</span>
<span id="cb12-502"><a href="#cb12-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-503"><a href="#cb12-503" aria-hidden="true" tabindex="-1"></a><span class="co"># below SECRET string is a 10-digit random string that will be saved</span></span>
<span id="cb12-504"><a href="#cb12-504" aria-hidden="true" tabindex="-1"></a>rspasswd <span class="op">=</span> `tr <span class="op">-</span>dc A<span class="op">-</span>Za<span class="op">-</span>z0<span class="op">-</span><span class="dv">9</span> <span class="op">&lt;</span> <span class="op">/</span>dev<span class="op">/</span>urandom <span class="op">|</span> head <span class="op">-</span>c <span class="dv">10</span><span class="op">;</span> echo`</span>
<span id="cb12-505"><a href="#cb12-505" aria-hidden="true" tabindex="-1"></a>echo $rspasswd <span class="op">&gt;</span> <span class="op">/</span>home<span class="op">/</span>rstudio<span class="op">/</span>.rstudio<span class="op">-</span>pw</span>
<span id="cb12-506"><a href="#cb12-506" aria-hidden="true" tabindex="-1"></a>echo <span class="op">-</span>e <span class="st">"$rspasswd</span><span class="ch">\n</span><span class="st">$rspasswd"</span> <span class="op">|</span> passwd rstudio</span>
<span id="cb12-507"><a href="#cb12-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-508"><a href="#cb12-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-509"><a href="#cb12-509" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Couple of useful tools</span></span>
<span id="cb12-510"><a href="#cb12-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-513"><a href="#cb12-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-514"><a href="#cb12-514" aria-hidden="true" tabindex="-1"></a><span class="co"># Install a couple of useful tools</span></span>
<span id="cb12-515"><a href="#cb12-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-516"><a href="#cb12-516" aria-hidden="true" tabindex="-1"></a>yum install <span class="op">-</span>y pciutils net<span class="op">-</span>tools nc</span>
<span id="cb12-517"><a href="#cb12-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-518"><a href="#cb12-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-519"><a href="#cb12-519" aria-hidden="true" tabindex="-1"></a><span class="fu">#### systemctl dependencies</span></span>
<span id="cb12-520"><a href="#cb12-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-521"><a href="#cb12-521" aria-hidden="true" tabindex="-1"></a>A big part of the deployment is to ensure that the services are being started by <span class="in">`systemd`</span> in the right order. For this, we tweak the systemd service definitions as follows:</span>
<span id="cb12-522"><a href="#cb12-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-523"><a href="#cb12-523" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`slurmdbd`</span> reports it has started but the service is still starting up. This needs to be caught by a <span class="in">`ExecStartPost`</span> script that keeps polling until the <span class="in">`slurmdbd`</span> port is actually open.</span>
<span id="cb12-524"><a href="#cb12-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-525"><a href="#cb12-525" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`slurmd`</span> will only start properly if the nvidia driver has been loaded and the device <span class="in">`/dev/nvidia0`</span> has been created.</span>
<span id="cb12-526"><a href="#cb12-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-527"><a href="#cb12-527" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`nvidia-persistenced`</span> ensures that the nvidia kernel module is loaded - it hence depends on <span class="in">`dkms`</span> which on its own ensures the kernel module for nvidia is being recompiled for any new kernel.</span>
<span id="cb12-528"><a href="#cb12-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-529"><a href="#cb12-529" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`rstudio-server`</span> is only started after <span class="in">`rstudio-launcher`</span> in order to avoid triggering any <span class="in">`Connection refused`</span> messages from <span class="in">`rstudio-server`</span>.</span>
<span id="cb12-530"><a href="#cb12-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-531"><a href="#cb12-531" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`rstudio-server`</span> will start only after <span class="in">`slurmctld`</span> to ensure that SLURM Launcher is starting up properly.</span>
<span id="cb12-532"><a href="#cb12-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-535"><a href="#cb12-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-536"><a href="#cb12-536" aria-hidden="true" tabindex="-1"></a><span class="co"># Structure systemctl order of running services</span></span>
<span id="cb12-537"><a href="#cb12-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-538"><a href="#cb12-538" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=.*/After=dkms.service/'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>nvidia<span class="op">-</span>persistenced.service </span>
<span id="cb12-539"><a href="#cb12-539" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;slurmdbd.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmctld.service</span>
<span id="cb12-540"><a href="#cb12-540" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;slurmctld.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmd.service</span>
<span id="cb12-541"><a href="#cb12-541" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'/After=.*/a ConditionPathExists=\/dev\/nvidia0'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmd.service</span>
<span id="cb12-542"><a href="#cb12-542" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'/ExecReload=.*/a ExecStartPost=\/usr\/bin\/timeout 30 sh -c "while ! ss -H -t -l -n sport = \:6819 | grep -q ^LISTEN.*:6819; do sleep 1; done"'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>slurmdbd.service</span>
<span id="cb12-543"><a href="#cb12-543" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;rstudio-launcher.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>rstudio<span class="op">-</span>server.service</span>
<span id="cb12-544"><a href="#cb12-544" aria-hidden="true" tabindex="-1"></a>sed <span class="op">-</span>i <span class="st">'s/After=/&amp;slurmctld.service /'</span> <span class="op">/</span>usr<span class="op">/</span>lib<span class="op">/</span>systemd<span class="op">/</span>system<span class="op">/</span>rstudio<span class="op">-</span>launcher.service</span>
<span id="cb12-545"><a href="#cb12-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-546"><a href="#cb12-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-547"><a href="#cb12-547" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Reboot</span></span>
<span id="cb12-548"><a href="#cb12-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-549"><a href="#cb12-549" aria-hidden="true" tabindex="-1"></a>Finally we need to reboot the server in order to get the kernel module built and all the services started properly.</span>
<span id="cb12-550"><a href="#cb12-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-553"><a href="#cb12-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-554"><a href="#cb12-554" aria-hidden="true" tabindex="-1"></a>reboot</span>
<span id="cb12-555"><a href="#cb12-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>